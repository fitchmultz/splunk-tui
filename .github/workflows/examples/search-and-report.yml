# Scheduled Search and Report Generation Example
#
# This workflow demonstrates scheduled execution of Splunk searches
# and automated report generation with artifact upload.
#
# Usage: Copy this file to .github/workflows/ and customize as needed

name: Daily Security Report

on:
  schedule:
    # Run at 6 AM UTC daily
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      earliest:
        description: 'Earliest time for search'
        required: true
        default: '-24h'
      report-name:
        description: 'Report name suffix'
        required: false
        default: 'security'

env:
  SPLUNK_BASE_URL: ${{ secrets.SPLUNK_BASE_URL }}
  SPLUNK_API_TOKEN: ${{ secrets.SPLUNK_API_TOKEN }}

jobs:
  generate-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Run security summary search
      - name: Run Security Summary Search
        uses: ./.github/actions/splunk-search
        id: security-search
        with:
          query: |
            index=security earliest=${{ github.event.inputs.earliest || '-24h' }} 
            | stats count by severity, category 
            | sort -count
          earliest: ${{ github.event.inputs.earliest || '-24h' }}
          output-format: 'json'
          output-file: 'security-summary.json'

      # Run failed logins search
      - name: Run Failed Logins Search
        uses: ./.github/actions/splunk-search
        id: logins-search
        with:
          query: |
            index=security action=failure 
            | stats count by src_ip, user 
            | sort -count 
            | head 20
          earliest: ${{ github.event.inputs.earliest || '-24h' }}
          output-format: 'json'
          output-file: 'failed-logins.json'

      # Generate Markdown report from search results
      - name: Generate Markdown Report
        run: |
          report_date=$(date +%Y-%m-%d)
          report_name="${{ github.event.inputs.report-name || 'security' }}"
          
          cat > report.md << EOF
          # Security Report - $report_date
          
          Generated by: GitHub Actions  
          Run ID: ${{ github.run_id }}  
          Commit: ${{ github.sha }}
          
          ## Summary
          
          Total security events found: ${{ steps.security-search.outputs.result-count }}
          
          ### Events by Severity and Category
          
          | Severity | Category | Count |
          |----------|----------|-------|
          EOF
          
          # Add security summary data to table
          if [[ -f security-summary.json ]]; then
            jq -r '.[] | "| \(.severity // "N/A") | \(.category // "N/A") | \(.count // "N/A") |"' security-summary.json >> report.md
          fi
          
          cat >> report.md << EOF
          
          ## Top Failed Login Attempts
          
          | Source IP | User | Count |
          |-----------|------|-------|
          EOF
          
          # Add failed logins data to table
          if [[ -f failed-logins.json ]]; then
            jq -r '.[] | "| \(.src_ip // "N/A") | \(.user // "N/A") | \(.count // "N/A") |"' failed-logins.json >> report.md
          fi
          
          cat >> report.md << EOF
          
          ## Raw Data
          
          Raw search results are available as artifacts in JSON format.
          
          ---
          *This report was automatically generated by Splunk GitHub Actions*
          EOF
          
          echo "Report generated: report.md"
          cat report.md

      # Upload all artifacts
      - name: Upload Report Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.report-name || 'security' }}-report-${{ github.run_id }}
          path: |
            security-summary.json
            failed-logins.json
            report.md
          retention-days: 30

      # Optional: Send report notification via HEC
      - name: Send Report Completion Event
        if: success()
        uses: ./.github/actions/splunk-hec-send
        with:
          hec-url: ${{ secrets.SPLUNK_HEC_URL }}
          hec-token: ${{ secrets.SPLUNK_HEC_TOKEN }}
          event: |
            {
              "message": "Daily security report generated",
              "report_date": "$(date +%Y-%m-%d)",
              "security_events": ${{ steps.security-search.outputs.result-count }},
              "run_id": "${{ github.run_id }}",
              "status": "success"
            }
          index: 'ci_cd_events'
          sourcetype: 'github:report'
