{
  "version": 1,
  "tasks": [
    {
      "id": "RQ-0001",
      "status": "done",
      "title": "Refactor popup UI to Builder pattern and add structured logging",
      "priority": "high",
      "tags": [
        "ui",
        "refactor",
        "logging",
        "foundation"
      ],
      "scope": [
        "crates/tui/src/ui/popup.rs",
        "crates/tui/src/app.rs",
        "crates/tui/src/main.rs",
        "crates/tui/tests/snapshot_tests.rs",
        "crates/tui/tests/app_tests.rs",
        "crates/tui/src/lib.rs",
        "crates/tui/Cargo.toml",
        "crates/tui/src/ui/screens/jobs.rs",
        "crates/tui/src/action.rs",
        "crates/tui/tests/helpers.rs"
      ],
      "evidence": [
        "Plan FLIGHT 1: Foundation Refactor (Popup Builder & Observability)",
        "Objective: Execute architectural evolution to establish UI robustness"
      ],
      "plan": [
        "Modify crates/tui/src/ui/popup.rs: Implement PopupBuilder with fluent API (title, content, style, build). Replace static helper functions with flexible render method accepting Popup state.",
        "Modify crates/tui/src/app.rs: Define const values for UI layout (header height, footer height). Update Popup enum to use richer structure (Confirm {title, message, action}, Info {title, message}, Help) and integrate with Builder.",
        "Modify crates/tui/src/main.rs: Initialize tracing with subscriber that logs to file (tui interferes with stdout). Add info! logs on Action receipt for observability.",
        "Modify crates/tui/tests/snapshot_tests.rs: Update popup test fixtures to use new Builder syntax. Remove unused import: helpers::*."
      ],
      "notes": [
        "Added PopupType enum (Help, ConfirmCancel(String), ConfirmDelete(String)) and Popup struct with title, content, kind fields.",
        "Implemented PopupBuilder with fluent API (title(), content(), build()).",
        "Added layout constants: HEADER_HEIGHT = 3, FOOTER_HEIGHT = 3, POPUP_WIDTH_PERCENT = 60, POPUP_HEIGHT_PERCENT = 20.",
        "Refactored render_popup() to use Popup struct instead of enum, extracting kind field for pattern matching.",
        "Updated all popup creation sites to use Builder pattern: Popup::builder(PopupType::Help).build().",
        "Added file-based logging with tracing-appender: logs/splunk-tui.log with daily rotation.",
        "Added action logging in main loop: tracing::info!(?action, \"Handling action\").",
        "Updated lib.rs to re-export Popup, PopupType, HEADER_HEIGHT, FOOTER_HEIGHT.",
        "Updated all tests to use new Builder API and match on popup.kind field.",
        "Added Default implementations for SortState and App (clippy requirements).",
        "Refactored render_jobs() to use JobsRenderConfig struct to fix clippy too_many_arguments warning.",
        "Fixed all clippy warnings (dead_code, new_without_default, too_many_arguments)."
      ],
      "request": "Read /tmp/plan.md and build out the task queue based on the plan provided.",
      "created_at": "2025-01-19T00:00:00Z",
      "updated_at": "2026-01-19T00:00:00Z",
      "completed_at": "2026-01-19T00:00:00Z",
      "depends_on": []
    },
    {
      "id": "RQ-0002",
      "status": "done",
      "title": "Implement Job Inspection details view screen",
      "priority": "high",
      "tags": [
        "ui",
        "feature",
        "inspection",
        "state"
      ],
      "scope": [
        "crates/tui/src/ui/screens/job_details.rs",
        "crates/tui/src/ui/screens/mod.rs",
        "crates/tui/src/app.rs",
        "crates/tui/src/action.rs",
        "crates/tui/src/ui/popup.rs",
        "crates/tui/tests/app_tests.rs",
        "crates/tui/tests/snapshot_tests.rs"
      ],
      "evidence": [
        "Plan FLIGHT 2: Job Inspection (Details View)",
        "Unlock data depth with detailed job inspection capability"
      ],
      "plan": [
        "Create crates/tui/src/ui/screens/job_details.rs: Implement render_details(f: &mut Frame, job: &SearchJobStatus, area: Rect). Use List or Table to show all fields of SearchJobStatus.",
        "Modify crates/tui/src/ui/screens/mod.rs: Export new job_details module.",
        "Modify crates/tui/src/action.rs: Add InspectJob and ExitScreen actions. Remove dead_code warnings for SearchInput and ToggleSortDirection by implementing usage or removing unused variants.",
        "Modify crates/tui/src/app.rs: Add JobDetails variant to CurrentScreen enum. Add selected_job: Option<SearchJobStatus> to App struct. In render(), route CurrentScreen::JobDetails to screens::job_details::render_details.",
        "Modify crates/tui/src/ui/screens/jobs.rs: In handle_input, map Enter key to Action::InspectJob."
      ],
      "notes": [
        "Created job_details.rs screen module with render_details() function displaying all SearchJobStatus fields (SID, status with color-coding, duration, event/scan/result counts, disk usage, priority, label, cursor time, finalized status).",
        "Added JobInspect variant to CurrentScreen enum in app.rs.",
        "Added InspectJob and ExitInspectMode actions to action.rs.",
        "Implemented handle_job_inspect_input() method in app.rs with Esc key to exit inspect mode.",
        "Mapped Enter key in handle_jobs_input() to trigger InspectJob action.",
        "Added render_job_details() helper method that dynamically retrieves selected job from jobs list using jobs_state.selected().",
        "Added JobInspect branch to render_content() match statement.",
        "Updated header rendering to show 'Job Details' when in JobInspect screen.",
        "Updated help popup to include 'Enter Inspect job' under Jobs Screen and 'Esc Back to jobs' under Job Details Screen.",
        "Added three state transition tests in app_tests.rs: test_job_inspection_flow, test_job_inspection_without_jobs, test_job_inspect_help_popup.",
        "Added four snapshot tests in snapshot_tests.rs: snapshot_job_details_screen_with_job, snapshot_job_details_screen_running_job, snapshot_job_details_screen_no_job, snapshot_job_details_screen_with_help_popup.",
        "All tests pass and make ci completes successfully."
      ],
      "request": "Read /tmp/plan.md and build out the task queue based on the plan provided.",
      "created_at": "2025-01-19T00:00:00Z",
      "updated_at": "2026-01-19T00:00:00Z",
      "completed_at": "2026-01-19T00:00:00Z",
      "depends_on": []
    },
    {
      "id": "RQ-0003",
      "status": "done",
      "title": "Implement configuration persistence with directories and JSON",
      "priority": "medium",
      "tags": [
        "config",
        "persistence",
        "cross-platform",
        "serialization",
        "json"
      ],
      "scope": [
        "crates/config/Cargo.toml",
        "crates/config/src/persistence.rs",
        "crates/config/src/lib.rs",
        "crates/tui/src/app.rs",
        "crates/tui/src/main.rs"
      ],
      "evidence": [
        "Plan FLIGHT 3: Configuration Persistence",
        "Establish permanence with cross-platform config storage",
        "User feedback: JSON is more robust and safe than TOML for config persistence"
      ],
      "plan": [
        "Modify crates/config/Cargo.toml: Add directories = \"6.0\" for cross-platform config paths. Add serde_json = { workspace = true } to dependencies (already in workspace, just reference it).",
        "Create crates/config/src/persistence.rs: Implement PersistedState struct with Serialize/Deserialize derives (auto_refresh: bool, sort_column: String, sort_direction: String, last_search_query: Option<String>). Implement ConfigManager with load_or_default() using serde_json::from_str and save() using serde_json::to_string_pretty.",
        "Modify crates/config/src/lib.rs: Export persistence types (PersistedState, ConfigManager).",
        "Modify crates/tui/src/app.rs: Add UserConfig struct to state. Initialize App state (auto_refresh, sort) from loaded config.",
        "Modify crates/tui/src/main.rs: Load config on startup via ConfigManager. Call ConfigManager::save on Action::Quit to persist state."
      ],
      "notes": [
        "Added directories = \"6.0\" and serde_json = { workspace = true } dependencies to crates/config/Cargo.toml.",
        "Added tracing = { workspace = true } for logging in config crate.",
        "Created crates/config/src/persistence.rs with PersistedState struct (auto_refresh: bool, sort_column: String, sort_direction: String, last_search_query: Option<String>) and Default impl.",
        "Implemented ConfigManager with new() -> Result<Self> using ProjectDirs::from(\"com\", \"splunk-tui\", \"splunk-tui\").",
        "Implemented load() -> PersistedState that returns default on missing/error with warning log.",
        "Implemented save(&self, state: &PersistedState) -> Result<()> that creates parent dirs and writes to config.json.",
        "Exported ConfigManager and PersistedState from crates/config/src/lib.rs.",
        "Added as_str() methods to SortColumn and SortDirection enums for serialization.",
        "Added parse_sort_column() and parse_sort_direction() helper functions for deserialization with fallback defaults.",
        "Modified App::new() to accept Option<PersistedState> parameter and initialize state from persisted values.",
        "Added App::get_persisted_state() -> PersistedState method to export current state.",
        "Modified crates/tui/src/main.rs to initialize ConfigManager, load persisted state on startup, and save on quit.",
        "Updated Default impl for App to call App::new(None).",
        "Fixed all test files (app_tests.rs, snapshot_tests.rs) to call App::new(None).",
        "All tests pass and make ci completes successfully."
      ],
      "request": "Review the RQ-0003 task and dependent tasks in the queue. I think using JSON for config persistence is a more robust and safe choice. If you agree, update the task and any dependent tasks.",
      "created_at": "2025-01-19T00:00:00Z",
      "updated_at": "2026-01-20T03:27:48Z",
      "completed_at": "2026-01-20T03:30:00Z",
      "depends_on": [
        "RQ-0002"
      ]
    },
    {
      "id": "RQ-0004",
      "status": "done",
      "title": "Implement async toast notifications with UUID tracking",
      "priority": "medium",
      "tags": [
        "ui",
        "async",
        "notifications",
        "feedback"
      ],
      "scope": [
        "crates/tui/Cargo.toml",
        "crates/tui/src/ui/toast.rs",
        "crates/tui/src/ui/mod.rs",
        "crates/tui/src/lib.rs",
        "crates/tui/src/action.rs",
        "crates/tui/src/app.rs",
        "crates/tui/src/main.rs",
        "crates/tui/tests/app_tests.rs",
        "crates/tui/tests/snapshot_tests.rs"
      ],
      "evidence": [
        "Plan FLIGHT 4: Async Orchestration & Feedback",
        "Refine user feedback with async notification system"
      ],
      "plan": [
        "Modify crates/tui/Cargo.toml: Add uuid = { version = \"1.11\", features = [\"v4\"] } for unique async operation tracking.",
        "Create crates/tui/src/ui/toast.rs: Implement ToastLevel enum (Info, Success, Warning, Error). Implement Toast struct (id: Uuid, message: String, level: ToastLevel, created_at: Instant, ttl: Duration). Implement render_toasts() function for bottom-right overlay rendering.",
        "Modify crates/tui/src/ui/mod.rs: Export toast module and re-export Toast, ToastLevel.",
        "Modify crates/tui/src/lib.rs: Re-export Toast and ToastLevel at crate root.",
        "Modify crates/tui/src/action.rs: Add Notify(ToastLevel, String) and Tick action variants. Remove Error(String) variant.",
        "Modify crates/tui/src/app.rs: Replace error: Option<String> with toasts: Vec<Toast>. Add TTL pruning logic in Tick handler. Update render() to call render_toasts() and remove error footer display.",
        "Modify crates/tui/src/main.rs: Change tick interval from 1s to 250ms for smooth animations. Separate data refresh (5s) from UI tick (250ms). Update handle_side_effects to emit Action::Notify instead of Action::Error.",
        "Modify crates/tui/tests/app_tests.rs: Update error test to use toasts. Add test_notify_adds_toast and test_tick_prunes_expired_toasts tests.",
        "Modify crates/tui/tests/snapshot_tests.rs: Update snapshot_error_state to use Toast::error() instead of error field."
      ],
      "notes": [
        "Added uuid = { version = \"1.11\", features = [\"v4\"] } dependency to crates/tui/Cargo.toml.",
        "Created crates/tui/src/ui/toast.rs with ToastLevel enum (Info, Success, Warning, Error), Toast struct with UUID/ttl/created_at fields, and render_toasts() function.",
        "Toast TTL by level: Info/Success/Warning = 5 seconds, Error = 10 seconds.",
        "Implemented Toast constructors: info(), success(), warning(), error().",
        "Added #[allow(dead_code)] attributes for public API methods not yet used (remaining, info, success, warning, from_str, non-Error ToastLevel variants).",
        "Exported toast module from ui/mod.rs and re-exported Toast, ToastLevel from lib.rs.",
        "Added Notify(ToastLevel, String) and Tick actions to action.rs. Removed Error(String) variant.",
        "Replaced App.error field with App.toasts: Vec<Toast>.",
        "Added Tick handler to prune expired toasts using retain().",
        "Updated all error handling to push Toast::error() instead of setting error field.",
        "Changed main loop tick interval from 1s to 250ms for smooth UI animations and TTL pruning.",
        "Decoupled data refresh (5s interval) from UI tick (250ms interval) for responsive UI.",
        "Updated handle_side_effects to emit Action::Notify(ToastLevel::Error, ...) for cancel/delete job failures.",
        "Updated footer rendering to remove error display (now shown as toasts).",
        "Added render_toasts() call in App::render() after footer, before popup (toasts render below popups).",
        "Updated tests: test_error_state_clears_on_loading -> test_notify_adds_toast, added test_tick_prunes_expired_toasts.",
        "Updated snapshot_error_state to use Toast::error() with bottom-right overlay rendering.",
        "Fixed clippy warnings: added #[allow(clippy::should_implement_trait)] for from_str, used std::iter::repeat_n() instead of repeat().take().",
        "All tests pass (5 toast tests + existing tests) and make ci completes successfully."
      ],
      "request": "Read /tmp/plan.md and build out the task queue based on the plan provided.",
      "created_at": "2025-01-19T00:00:00Z",
      "updated_at": "2026-01-20T04:00:00Z",
      "completed_at": "2026-01-20T04:00:00Z",
      "depends_on": [
        "RQ-0003"
      ]
    },
    {
      "id": "RQ-0005",
      "status": "done",
      "title": "Add 429 retry with exponential backoff to client requests",
      "priority": "high",
      "tags": [
        "client",
        "reliability",
        "retry"
      ],
      "scope": [
        "crates/client/src/client.rs",
        "crates/client/src/endpoints/",
        "crates/client/tests/integration_tests.rs"
      ],
      "evidence": [
        "crates/client/src/client.rs defines max_retries on SplunkClient but no retry logic is used by endpoint calls.",
        "crates/client/src/endpoints/* perform a single reqwest call and return ApiError on non-success without retries."
      ],
      "plan": [
        "Introduce a shared request helper (client or endpoints) that wraps reqwest calls and retries 429 responses with 1s/2s/4s backoff up to max_retries.",
        "Route endpoint functions through the helper so all API calls consistently retry on 429.",
        "Add wiremock tests that return 429 twice then 200 to assert backoff + retry behavior."
      ],
      "notes": [
        "Created crates/client/src/endpoints/request.rs with send_request_with_retry() function that wraps reqwest calls with retry logic.",
        "Implemented exponential backoff: 2^attempt seconds (1s, 2s, 4s) for retries on HTTP 429 responses.",
        "Added tracing::debug logging for retry attempts with attempt number, max_retries, and backoff duration.",
        "Returns MaxRetriesExceeded error when retries are exhausted, propagates other reqwest errors immediately.",
        "Uses RequestBuilder::try_clone() for retries, falls back to single attempt if cloning fails.",
        "Exported send_request_with_retry from endpoints/mod.rs.",
        "Updated all endpoint functions to accept max_retries parameter: login(), get_job(), list_jobs(), cancel_job(), delete_job(), create_job(), get_job_status(), wait_for_job(), get_results(), get_cluster_info(), get_cluster_peers(), list_indexes().",
        "Updated SplunkClient to pass self.max_retries to all endpoint calls.",
        "Added #[allow(clippy::too_many_arguments)] to get_results() function.",
        "Added two integration tests: test_retry_on_429_success (mock returns 429 twice then 200), test_retry_on_429_exhaustion (mock always returns 429).",
        "Updated all existing integration tests to pass max_retries=3 parameter.",
        "All 17 integration tests pass and make ci completes successfully."
      ],
      "request": "scan finding",
      "created_at": "2026-01-20T04:18:41Z",
      "updated_at": "2026-01-20T04:18:41Z",
      "completed_at": "2026-01-20T05:00:00Z",
      "depends_on": []
    },
    {
      "id": "RQ-0006",
      "status": "done",
      "title": "Retry on 401/403 by clearing session and re-authenticating",
      "priority": "high",
      "tags": [
        "client",
        "auth",
        "session"
      ],
      "scope": [
        "crates/client/src/client.rs",
        "crates/client/src/auth.rs",
        "crates/client/src/endpoints/"
      ],
      "evidence": [
        "crates/client/src/client.rs get_auth_token only checks session expiry; endpoints return ApiError on 401/403 without re-login.",
        "crates/client/src/auth.rs has clear_session() but it is not used by request paths."
      ],
      "plan": [
        "Add a request wrapper that detects 401/403 for session auth, clears the session, logs in, and retries once.",
        "Ensure API token auth does not attempt re-login and surfaces the error.",
        "Add integration tests that return 401 then success and assert the retry path."
      ],
      "notes": [
        "Added tracing::info logging for session refresh events on 401/403.",
        "Implemented 401/403 retry logic in all API methods: create_search_job, get_search_results, get_job_status, list_jobs, cancel_job, delete_job, list_indexes, get_cluster_info, get_cluster_peers, and wait_for_job (in search method).",
        "For session auth (AuthStrategy::SessionToken): On 401/403, clear session via session_manager.clear_session(), re-login via login(), and retry the operation once.",
        "For API token auth (AuthStrategy::ApiToken): 401/403 errors propagate immediately without retry since API tokens have no renewal mechanism.",
        "Fixed bug in search method: wait_for_job had an extra parameter (200) that didn't match the function signature - removed it.",
        "Added 4 integration tests: test_retry_on_401_session_auth, test_retry_on_403_session_auth, test_no_retry_on_401_api_token, test_retry_fails_on_second_401.",
        "Used Arc<AtomicUsize> for tracking login count in wiremock tests (required because wiremock closures need Fn, not FnMut).",
        "All 21 integration tests pass and make ci completes successfully."
      ],
      "request": "scan finding",
      "created_at": "2026-01-20T04:18:41Z",
      "updated_at": "2026-01-20T04:54:39.423691+00:00",
      "depends_on": [],
      "completed_at": "2026-01-20T04:54:39.423506+00:00"
    },
    {
      "id": "RQ-0007",
      "status": "done",
      "title": "Fix OutputMode::Json parsing for search results and add object-response coverage",
      "priority": "high",
      "tags": [
        "client",
        "search",
        "parsing"
      ],
      "scope": [
        "crates/client/src/endpoints/search.rs",
        "crates/client/fixtures/search/",
        "crates/client/tests/integration_tests.rs"
      ],
      "evidence": [
        "crates/client/src/endpoints/search.rs uses json.as_array() for OutputMode::Json and json[\"results\"] only for non-json modes.",
        "crates/client/fixtures/search/get_results.json is an array fixture, so object responses are not covered."
      ],
      "plan": [
        "Update get_results parsing to accept either an array or an object with a results field for OutputMode::Json.",
        "Add a second fixture representing the object response and cover it in integration tests.",
        "Keep preview/total fields consistent with the object response when present."
      ],
      "notes": [
        "Updated get_results() in crates/client/src/endpoints/search.rs to handle both array format ([{...}]) and object-wrapped format ({results: [...]}) for OutputMode::Json responses.",
        "Changed from if/else to match expression for clearer branching logic.",
        "Added graceful fallback to empty vec when neither format matches.",
        "Created new fixture crates/client/fixtures/search/get_results_object.json representing object-wrapped response with preview, init_offset, messages, results array, and total fields.",
        "Added integration test test_get_search_results_object_style() verifying object-style parsing works correctly with results array, preview=false, and total=1.",
        "Fixed clippy warning: changed assert_eq!(results.preview, false) to assert!(!results.preview).",
        "All 22 integration tests pass (including new object-style test) and make ci completes successfully."
      ],
      "request": "scan finding",
      "created_at": "2026-01-20T04:18:41Z",
      "updated_at": "2026-01-20T04:58:39Z",
      "depends_on": [],
      "completed_at": "2026-01-20T04:58:39Z"
    },
    {
      "id": "RQ-0008",
      "status": "done",
      "title": "Fix jobs filter apply/clear flow so filters persist after Enter",
      "priority": "high",
      "tags": [
        "tui",
        "jobs",
        "filter"
      ],
      "scope": [
        "crates/tui/src/app.rs",
        "crates/tui/tests/app_tests.rs"
      ],
      "evidence": [
        "crates/tui/src/app.rs handle_jobs_input sets search_filter then returns Action::ClearSearch on Enter, but update() clears search_filter on ClearSearch.",
        "Action::ClearSearch is used for both clearing and applying filters, so applying a filter immediately clears it."
      ],
      "plan": [
        "Introduce a dedicated ApplyFilter action or change ClearSearch semantics to avoid clearing on Enter when a filter is set.",
        "Update update() to apply the new action and keep search_filter set.",
        "Add tests to assert filters persist after Enter and are cleared only on Esc/explicit clear."
      ],
      "notes": [
        "Fixed crates/tui/src/app.rs handle_jobs_input() Enter key handling: returns None instead of Action::ClearSearch when applying a non-empty filter, so search_filter persists.",
        "Empty input on Enter still returns Action::ClearSearch to clear the existing filter.",
        "Added 3 regression tests in crates/tui/tests/app_tests.rs: test_jobs_filter_persistence (verifies filter persists after Enter), test_jobs_filter_clear_with_empty_input (verifies empty input clears filter), test_jobs_filter_cancel_with_escape (verifies Esc returns ClearSearch).",
        "All tests pass and make ci completes successfully."
      ],
      "request": "scan finding",
      "created_at": "2026-01-20T04:18:41Z",
      "updated_at": "2026-01-20T04:18:41Z",
      "depends_on": [],
      "completed_at": "2026-01-20T05:30:00Z"
    }
  ]
}
